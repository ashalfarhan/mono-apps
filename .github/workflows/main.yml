name: Main Workflow

on:
  push:
    paths-ignore:
      - '**.md'

env:
  CI: true
  NODE_VERSION: 16.13
  CACHE_VERSION: v1

jobs:
  modules-changed:
    name: 🔦 Detecting which modules changed
    runs-on: ubuntu-latest
    outputs:
      spa: ${{ contains(steps.changed-files.outputs.all_modified_files, 'apps/spa/') }}
      ui: ${{ contains(steps.changed-files.outputs.all_modified_files, 'libs/ui/') }}
      uicore: ${{ contains(steps.changed-files.outputs.all_modified_files, 'libs/uicore/') }}
    steps:
      - name: 📥 Checkout repo
        uses: actions/checkout@v3
      - name: 🔦 Find file changes
        id: changed-files
        uses: tj-actions/changed-files@v31
  ci:
    needs: [modules-changed]
    name: 👷‍♀️ Continous Integration
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout repo
        uses: actions/checkout@v3
      - name: 🐢 Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
      - name: 🗑 Restore cache
        uses: actions/cache@v3
        id: cache-deps
        with:
          path: |
            node_modules
            apps/**/node_modules
            libs/**/node_modules
          key: yarn-${{ runner.os }}-${{ env.CACHE_VERSION }}-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            yarn-${{ runner.os }}-${{ env.CACHE_VERSION }}-
      - name: ⬇️ Install dependencies
        if: ${{ steps.cache-deps.outputs.cache-hit != 'true' }}
        run: yarn install --frozen-lockfile
